{% extends "base.html" %} {% block title %} Manage Projects{% endblock %}
{% block body %}

<div class="container-fluid px-0">
     <!-- New Project Button -->
    <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#newProjectModal">
        + Create Project
    </button>

    <div class="row" id="projectsContainer">
    
    </div>

    <!-- New Project Modal -->
    <div class="modal fade" id="newProjectModal" tabindex="-1" aria-labelledby="newProjectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newProjectModalLabel">Create New Project</h5>
                    <button type="button" class="btn-close" onclick="closeModal()" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name</label>
                        <input type="text" class="form-control" id="projectName" placeholder="Enter project name">
                    </div>
                    <div class="mb-3">
                        <label for="projectDetails" class="form-label">Project Details</label>
                        <textarea class="form-control" id="projectDetails" rows="4" placeholder="Enter project details"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" onclick="closeModal()">Close</button>
                    <button type="button" class="btn btn-success" id="saveProjectBtn" onclick="saveProject()">Save</button>
                    <button type="button" class="btn btn-success" id="updateProjectBtn" onclick="updateProject()" style="display: none;">Update</button>
                </div>
            </div><!-- /.modal-content -->
        </div>
    </div>
</div>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    loadprojects();
});
function loadprojects() {
    $.ajax({
        url: "/projects/loadprojects",
        type: "GET",
        success: function(data) {
            try {
                if (data.error_code === 0) {
                    var projects = data.projects;
                    var projectListHtml = '';
                    for (var i = 0; i < projects.length; i++) {
                        var project = projects[i];
                        var ago = "";
                        if (!project.created_on) {
                            ago = "Not Found";
                        } else {
                            var diff = Date.now() - new Date(project.created_on).getTime();
                            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
                            ago = days < 1 ? "Today" :
                                days === 1 ? "1 day ago" :
                                days < 30 ? days + " days ago" :
                                days < 365 ? Math.floor(days / 30) + " months ago" :
                                Math.floor(days / 365) + " years ago";
                        }

                         projectListHtml += `
                            <div class="col-xl-4">
                                <div class="card border rounded-3">
                                    
                                    <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                                        <h6 class="mb-0">${project.project_name}</h6>
                                        <div class="dropdown">
                                            <a href="#" class="text-white" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="ri-more-2-fill"></i>
                                            </a>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li><a class="dropdown-item" Onclick="editProject(${project.id}, '${project.project_name}', '${project.project_details}')">Edit</a></li>
                                                <li><a class="dropdown-item" Onclick="deleteProject(${project.id})">Delete</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">

                                            <div class="col-6">
                                                <p class="mb-1 text-muted">Status</p>
                                                <span class="badge bg-success">${project.status}</span>
                                                
                                                <p class="mt-3 mb-1 text-muted">
                                                    <i class="ri-time-line"></i> ${ago}
                                                </p>
                                            </div>
                                            <div class="col-6">
                                                <p class="mb-1 text-muted">Created By</p>
                                                <p class="mb-2">${project.created_by}</p>
                                            </div>
                                        </div>
                                        <hr class="my-3">
                                        <div>
                                            <p class="fs-25 lh-base">
                                                ${project.project_details}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    $("#projectsContainer").html(projectListHtml);

                } else {
                    nocodealert(data.msg, 'error', 2000);
                }
            } catch {
            }
        },
        error: function(xhr) {
            nocodealert("Unexpected error occurred.", 'error', 2000);
        }
    });
}
function closeModal() {
    $('#projectName').val('');
    $('#projectDetails').val('');
    $("#saveProjectBtn").show();
    $("#updateProjectBtn").hide();
    $("#newProjectModalLabel").text("Create New Project");
    $('#newProjectModal').modal('hide');
    curentProjectId = null
}
function saveProject() {
    var projectName = $("#projectName").val();
    var projectDetails = $("#projectDetails").val();

    if (!projectName) {
        nocodealert("Please enter project name.", 'warning', 1500);
        return;
    }
    if (!projectDetails) {
        nocodealert("Please enter project details.", 'warning', 1500);
        return;
    }

    $.ajax({
        url: "/projects/save_project",
        type: "POST",
        data: {
            project_name: projectName,
            project_details: projectDetails
        },
        success: function(response) {
            try {
            var data = JSON.parse(response);
            console.log(data);
            if (data["error_code"] === 0) {
                nocodealert(data["msg"], 'success', 2000);
                closeModal();
                loadprojects();
            } else {
                nocodealert(data["msg"], 'error', 2000);
            }
            } catch {
            }
        },
        error: function(xhr) {
            nocodealert("Unexpected error occurred.", 'error', 2000);  
        }
    });
}
let curentProjectId = null;
function editProject(id, name, details) {
    currentProjectId = id;
    $("#projectName").val(name);
    $("#projectDetails").val(details);

    $("#saveProjectBtn").hide();
    $("#updateProjectBtn").show();

    $("#newProjectModalLabel").text("Edit Project");
    $("#newProjectModal").modal("show");
}
function updateProject() {
    if (!currentProjectId) {
        nocodealert("Project ID not found.", 'error', 1500);
        return;
    }

    var projectName = $("#projectName").val();
    var projectDetails = $("#projectDetails").val();

    if (!projectName) {
        nocodealert("Please enter project name.", 'warning', 1500);
        return;
    }
    if (!projectDetails) {
        nocodealert("Please enter project details.", 'warning', 1500);
        return;
    }

    $.ajax({
        url: "/projects/update_project",
        type: "POST",
        data: {
            id: currentProjectId,
            project_name: projectName,
            project_details: projectDetails
        },
        success: function(response) {
            try {
                var data = JSON.parse(response);
                if (data.error_code === 0) {
                    nocodealert(data.msg, 'success', 2000);
                    closeModal();
                    loadprojects();
                } else {
                    nocodealert(data.msg, 'error', 2000);
                }
            } catch {
                nocodealert("Unexpected error occurred.", 'error', 2000);
            }
        },
        error: function() {
            nocodealert("Unexpected error occurred.", 'error', 2000);
        }
    });
}

function deleteProject(id) {
    nocodeConfirm(
        "Do you really want to delete this project?",
        "Delete",
        "Cancel"
    ).then((confirmed) => {
        if (confirmed) {
            $.ajax({
                url: "/projects/delete_project",
                type: "POST",
                data: { id: id },
                success: function(response) {
                    try {
                        var data = JSON.parse(response);
                        if (data.error_code === 0) {
                            nocodealert(data.msg, 'success', 2000);
                            loadprojects();
                        } else {
                            nocodealert(data.msg, 'error', 2000);
                        }
                    } catch {
                    }
                },
                error: function() {
                    nocodealert("Unexpected error occurred.", 'error', 2000);
                }
            });
        }
    });
}
</script>
{%endblock%}